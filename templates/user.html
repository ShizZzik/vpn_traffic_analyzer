<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{{ user.clientName }} - Настройки</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <h1><i class="fas fa-user-cog"></i> Настройки пользователя: {{ user.clientName }}</h1>
    <button id="themeToggle" class="theme-btn">Тёмная тема</button>
    <div class="user-profile">
        <img src="/static/avatars/{{ user.clientId }}.png" alt="Аватар" class="avatar" onerror="this.src='/static/avatars/default.png'">
        <form id="avatarForm" enctype="multipart/form-data" class="avatar-upload">
            <label><i class="fas fa-camera"></i> Загрузить аватар:</label>
            <input type="file" name="avatar" accept="image/*">
            <button type="submit">Загрузить</button>
        </form>
        <ul class="user-details">
            <li><i class="fas fa-network-wired"></i> <strong>IP:</strong> <span class="ip-address">{{ user.allowedIps }}</span></li>
            <li><i class="fas fa-handshake"></i> <strong>Последний handshake:</strong> 
                {% if "Нет активности" in user.latestHandshake %}
                    {{ user.latestHandshake }}
                {% else %}
                    <span class="time-hours">{{ user.latestHandshake.split(',')[0] }}</span>, 
                    <span class="time-minutes">{{ user.latestHandshake.split(',')[1] }}</span>, 
                    <span class="time-seconds">{{ user.latestHandshake.split(',')[2] }}</span>
                {% endif %}
            </li>
            <li><i class="fas fa-server"></i> <strong>Эндпоинт:</strong> 
                {% if ':' in user.endpoint %}
                    <span class="endpoint-ip">{{ user.endpoint.split(':')[0] }}</span>:<span class="endpoint-port">{{ user.endpoint.split(':')[1] }}</span>
                {% else %}
                    {{ user.endpoint }}
                {% endif %}
            </li>
            <li><i class="fas fa-exchange-alt"></i> <strong>Трафик (wg):</strong> 
                <span class="traffic-in">Принято: {{ user.transferRx }}</span>, 
                <span class="traffic-out">Отправлено: {{ user.transferTx }}</span>
            </li>
        </ul>
    </div>
    <div class="settings">
        <h2><i class="fas fa-cogs"></i> Настройки</h2>
        <form>
            <label><i class="fas fa-user"></i> Имя клиента: 
                <input type="text" value="{{ user.clientName }}" readonly>
            </label>
            <label><i class="fas fa-toggle-on"></i> Активен: 
                <input type="checkbox" id="activeSwitch" class="ios-switch" checked>
                <span class="switch-label"></span>
            </label>
            <button type="button" onclick="alert('Сохранение настроек пока не реализовано')">
                <i class="fas fa-save"></i> Сохранить
            </button>
        </form>
    </div>
    <div class="center-link">
        <a href="/" class="back-link"><i class="fas fa-arrow-left"></i> Назад к списку</a>
    </div>

    <script>
        const themeToggle = document.getElementById("themeToggle");
        let currentTheme = localStorage.getItem("theme") || "light";
        document.body.classList.toggle("dark-theme", currentTheme === "dark");
        themeToggle.textContent = currentTheme === "dark" ? "Светлая тема" : "Тёмная тема";

        themeToggle.addEventListener("click", () => {
            currentTheme = currentTheme === "light" ? "dark" : "light";
            document.body.classList.toggle("dark-theme");
            themeToggle.textContent = currentTheme === "dark" ? "Светлая тема" : "Тёмная тема";
            localStorage.setItem("theme", currentTheme);
        });

        document.getElementById("avatarForm").addEventListener("submit", function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch(`/upload_avatar/{{ user.clientName }}`, {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert(data.error);
                }
            })
            .catch(error => alert("Ошибка загрузки: " + error));
        });
    </script>
</body>
</html>
